<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/img/favicon.ico"><title>详解Spirng-目标方法参数-Reader和@RequestBody在Spring中如何抉择</title></head><body>　　<div class="inner"><h2>详解Spirng-目标方法参数-Reader和@RequestBody在Spring中如何抉择</h2><p>首先，我们都知道在使用spring框架的时候，无论是springmvc还是springboot，都可以在Controller层使用一些参数来取得我们想要的目的。</p>
<p>首先我们debug，进入最核心的方法中，发现核心方法就是ServletInvocableHandlerMethod类中的invokeAndHandle方法。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">方法入口和结束的地方就是ServletInvocableHandlerMethod.invokeAndHandle()方法中</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invokeAndHandle</span><span class="params">(ServletWebRequest webRequest, </span></span></span><br><span class="line"><span class="function"><span class="params">          ModelAndViewContainer mavContainer, Object... providedArgs)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  此处进入项目代码</span></span><br><span class="line"> Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs);</span><br><span class="line"><span class="comment">// 此处接受项目代码返回值</span></span><br><span class="line"> setResponseStatus(webRequest);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (returnValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (isRequestNotModified(webRequest) || hasResponseStatus() || mavContainer.isRequestHandled()) &#123;</span><br><span class="line">   mavContainer.setRequestHandled(<span class="keyword">true</span>);</span><br><span class="line">   <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.responseReason)) &#123;</span><br><span class="line">  mavContainer.setRequestHandled(<span class="keyword">true</span>);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> mavContainer.setRequestHandled(<span class="keyword">false</span>);</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.returnValueHandlers.handleReturnValue(</span><br><span class="line">    returnValue, getReturnValueType(returnValue), mavContainer, webRequest);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">  <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">   logger.trace(getReturnValueHandlingErrorMessage(<span class="string">"Error handling return value"</span>, returnValue), ex);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> ex;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">重点看invokeForRequest：</span><br><span class="line">调用Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);</span><br><span class="line"></span><br><span class="line">核心代码：InvocableHandlerMethod.getMethodArgumentValues(NativeWebRequest request, ModelAndViewContainer mavContainer,  Object... providedArgs) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Object[] getMethodArgumentValues(NativeWebRequest request, ModelAndViewContainer mavContainer,</span><br><span class="line">  Object... providedArgs) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="comment">// 获取所有的参数</span></span><br><span class="line"> MethodParameter[] parameters = getMethodParameters();</span><br><span class="line"><span class="comment">// 创建数组</span></span><br><span class="line"> Object[] args = <span class="keyword">new</span> Object[parameters.length];</span><br><span class="line"><span class="comment">// 遍历参数</span></span><br><span class="line"> <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameters.length; i++) &#123;</span><br><span class="line"><span class="comment">// 得到具体参数</span></span><br><span class="line">  MethodParameter parameter = parameters[i];</span><br><span class="line"></span><br><span class="line">  parameter.initParameterNameDiscovery(<span class="keyword">this</span>.parameterNameDiscoverer);</span><br><span class="line">  GenericTypeResolver.resolveParameterType(parameter, getBean().getClass());</span><br><span class="line">  args[i] = resolveProvidedArgument(parameter, providedArgs);</span><br><span class="line">  <span class="keyword">if</span> (args[i] != <span class="keyword">null</span>) &#123;</span><br><span class="line">   <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.argumentResolvers.supportsParameter(parameter)) &#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// 注意，此处是核心，进入此方法，则改变返回的到底之什么值</span></span><br><span class="line">    args[i] = <span class="keyword">this</span>.argumentResolvers.resolveArgument(</span><br><span class="line">      parameter, mavContainer, request, <span class="keyword">this</span>.dataBinderFactory);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">     logger.debug(getArgumentResolutionErrorMessage(<span class="string">"Error resolving argument"</span>, i), ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> ex;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (args[i] == <span class="keyword">null</span>) &#123;</span><br><span class="line">   String msg = getArgumentResolutionErrorMessage(<span class="string">"No suitable resolver for argument"</span>, i);</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg);</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>####调用HandlerMethodArgumentResolverComposite.resolveArgument（）<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter, ModelAndViewContainer mavContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">  NativeWebRequest webRequest, WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="comment">// 此处很重要，会返回不同的子类，不同的子类调用下面的方法有不同的实现</span></span><br><span class="line"> HandlerMethodArgumentResolver resolver = getArgumentResolver(parameter);</span><br><span class="line"> <span class="keyword">if</span> (resolver == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown parameter type ["</span> + parameter.getParameterType().getName() + <span class="string">"]"</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> resolver.resolveArgument(parameter, mavContainer, webRequest, binderFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>####然后调用resolver.resolveArgument(parameter, mavContainer, webRequest, binderFactory)；根据不同的resolver对象返回不同的值。这就是spring的抉择。应该算是状态模式吧。<br>那我们看看每次返回的具体子类是什么：<br>// Reader的方法参数的实现类是@ServletRequestMethodArgumentResolver<br>// @RequestBody注解的实现是@RequestResponseBodyMethodProcessor<br>// Map参数的实现类是@HandlerMethodArgumentResolverComposite</p>
<p>然后他们调用各自的resolveArgument(parameter, mavContainer, webRequest, binderFactory)方法<br>去实现自己的逻辑去解析。从而返回不同的参数。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Find a registered &#123;<span class="doctag">@link</span> HandlerMethodArgumentResolver&#125; that supports the given method parameter.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> HandlerMethodArgumentResolver <span class="title">getArgumentResolver</span><span class="params">(MethodParameter parameter)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 此方法决定返回什么值</span></span><br><span class="line"> HandlerMethodArgumentResolver result = <span class="keyword">this</span>.argumentResolverCache.get(parameter);</span><br><span class="line"> <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (HandlerMethodArgumentResolver methodArgumentResolver : <span class="keyword">this</span>.argumentResolvers) &#123;</span><br><span class="line">   <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">    logger.trace(<span class="string">"Testing if argument resolver ["</span> + methodArgumentResolver + <span class="string">"] supports ["</span> +</span><br><span class="line">      parameter.getGenericParameterType() + <span class="string">"]"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// 就是根据这个，是否支持某参数来确定resolver的返回的子类</span></span><br><span class="line">   <span class="keyword">if</span> (methodArgumentResolver.supportsParameter(parameter)) &#123;</span><br><span class="line">    result = methodArgumentResolver;</span><br><span class="line">    <span class="keyword">this</span>.argumentResolverCache.put(parameter, result);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>#####下面的方法返回了Reader<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter, ModelAndViewContainer mavContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">  NativeWebRequest webRequest, WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"> Class&lt;?&gt; paramType = parameter.getParameterType();</span><br><span class="line"> <span class="keyword">if</span> (WebRequest.class.isAssignableFrom(paramType)) &#123;</span><br><span class="line">  <span class="keyword">return</span> webRequest;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> HttpServletRequest request = webRequest.getNativeRequest(HttpServletRequest.class);</span><br><span class="line"> <span class="keyword">if</span> (ServletRequest.class.isAssignableFrom(paramType) || MultipartRequest.class.isAssignableFrom(paramType)) &#123;</span><br><span class="line">  Object nativeRequest = webRequest.getNativeRequest(paramType);</span><br><span class="line">  <span class="keyword">if</span> (nativeRequest == <span class="keyword">null</span>) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">     <span class="string">"Current request is not of type ["</span> + paramType.getName() + <span class="string">"]: "</span> + request);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> nativeRequest;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">if</span> (HttpSession.class.isAssignableFrom(paramType)) &#123;</span><br><span class="line">  <span class="keyword">return</span> request.getSession();</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">if</span> (HttpMethod.class == paramType) &#123;</span><br><span class="line">  <span class="keyword">return</span> ((ServletWebRequest) webRequest).getHttpMethod();</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">if</span> (Principal.class.isAssignableFrom(paramType)) &#123;</span><br><span class="line">  <span class="keyword">return</span> request.getUserPrincipal();</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">if</span> (Locale.class == paramType) &#123;</span><br><span class="line">  <span class="keyword">return</span> RequestContextUtils.getLocale(request);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">if</span> (TimeZone.class == paramType) &#123;</span><br><span class="line">  TimeZone timeZone = RequestContextUtils.getTimeZone(request);</span><br><span class="line">  <span class="keyword">return</span> (timeZone != <span class="keyword">null</span> ? timeZone : TimeZone.getDefault());</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"java.time.ZoneId"</span>.equals(paramType.getName())) &#123;</span><br><span class="line">  <span class="keyword">return</span> ZoneIdResolver.resolveZoneId(request);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">if</span> (InputStream.class.isAssignableFrom(paramType)) &#123;</span><br><span class="line">  <span class="keyword">return</span> request.getInputStream();</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">if</span> (Reader.class.isAssignableFrom(paramType)) &#123;</span><br><span class="line"><span class="comment">// 返回了Reader</span></span><br><span class="line">  <span class="keyword">return</span> request.getReader();</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// should never happen...</span></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(</span><br><span class="line">    <span class="string">"Unknown parameter type: "</span> + paramType + <span class="string">" in method: "</span> + parameter.getMethod());</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>######此方法返回了Json对象<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter, ModelAndViewContainer mavContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">  NativeWebRequest webRequest, WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"> parameter = parameter.nestedIfOptional();</span><br><span class="line"><span class="comment">// 就是下面的方法，层层调用，最后使用ObjectMapper解析了字符串，变成了@RequestBody中的对象</span></span><br><span class="line"> Object arg = readWithMessageConverters(webRequest, parameter, parameter.getNestedGenericParameterType());</span><br><span class="line"> String name = Conventions.getVariableNameForParameter(parameter);</span><br><span class="line"></span><br><span class="line"> WebDataBinder binder = binderFactory.createBinder(webRequest, arg, name);</span><br><span class="line"> <span class="keyword">if</span> (arg != <span class="keyword">null</span>) &#123;</span><br><span class="line">  validateIfApplicable(binder, parameter);</span><br><span class="line">  <span class="keyword">if</span> (binder.getBindingResult().hasErrors() &amp;&amp; isBindExceptionRequired(binder, parameter)) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> MethodArgumentNotValidException(parameter, binder.getBindingResult());</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> mavContainer.addAttribute(BindingResult.MODEL_KEY_PREFIX + name, binder.getBindingResult());</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> adaptArgumentIfNecessary(arg, parameter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">我们重写了解析了json的类，重写了<span class="number">240</span>行的代码，方便我们解析参数</span><br><span class="line"><span class="keyword">package</span> org.springframework.http.converter.json;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">read</span><span class="params">(Type type, Class&lt;?&gt; contextClass, HttpInputMessage inputMessage)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, HttpMessageNotReadableException </span>&#123;</span><br><span class="line"></span><br><span class="line">  JavaType javaType = getJavaType(type, contextClass);</span><br><span class="line">  <span class="keyword">return</span> readJavaType(javaType, inputMessage);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">readJavaType</span><span class="params">(JavaType javaType, HttpInputMessage inputMessage)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (inputMessage <span class="keyword">instanceof</span> MappingJacksonInputMessage) &#123;</span><br><span class="line">      Class&lt;?&gt; deserializationView = ((MappingJacksonInputMessage) inputMessage).getDeserializationView();</span><br><span class="line">      <span class="keyword">if</span> (deserializationView != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.objectMapper.readerWithView(deserializationView).forType(javaType).</span><br><span class="line">            readValue(inputMessage.getBody());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//在这里修改源码</span></span><br><span class="line">    InputStream inputStream = inputMessage.getBody();</span><br><span class="line">    String body = FileCopyUtils.copyToString(<span class="keyword">new</span> InputStreamReader(inputStream,<span class="string">"UTF-8"</span>));</span><br><span class="line">    body = mxr(body);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.objectMapper.readValue(body, javaType);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> HttpMessageNotReadableException(<span class="string">"Could not read document: "</span> + ex.getMessage(), ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这篇文章以代码居多，通过对spring如何修改参数的设置，我们可以在他的逻辑里定义自己想要的逻辑，比如修改参数。</p>
</div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>