<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/img/favicon.ico"><title>自己动手实现一个简单的-IOC</title></head><body>　　<div class="inner"><h2>自己动手实现一个简单的-IOC</h2><p>再上一篇文章中，楼主和大家一起分析spring的 IOC 实现，剖析了Spring的源码，看的出来，源码异常复杂，这是因为Spring的设计者需要考虑到框架的扩展性，健壮性，性能等待元素，因此设计的很复杂。楼主在最后也说要实现一个简单的 IOC，让我们更加深刻的理解IOC，因此，有了这篇文章。</p>
<p>当然我们是仿照Spring 的 IOC，因此代码命名和设计基本是仿照spring的。</p>
<p>我们将分为几步来编写简易 IOC，首先设计组件，再设计接口，然后关注实现。</p>
<h2 id="1-设计组件。"><a href="#1-设计组件。" class="headerlink" title="1. 设计组件。"></a>1. 设计组件。</h2><p>我们还记得Spring中最重要的有哪些组件吗？<code>BeanFactory</code> 容器，<code>BeanDefinition</code> Bean的基本数据结构，当然还需要加载Bean的<code>资源加载器</code>。大概最后最重要的就是这几个组件。容器用来存放初始化好的Bean，BeanDefinition 就是Bean的基本数据结构，比如Bean的名称，Bean的属性 <code>PropertyValue</code>，Bean的方法，是否延迟加载，依赖关系等。资源加载器就简单了，就是一个读取XML配置文件的类，读取每个标签并解析。</p>
<h2 id="2-设计接口"><a href="#2-设计接口" class="headerlink" title="2. 设计接口"></a>2. 设计接口</h2><p>首先肯定需要一个BeanFactory，就是Bean容器，容器接口至少有2个最简单的方法，一个是获取Bean，一个注册Bean.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 需要一个beanFactory 定义ioc 容器的一些行为 比如根据名称获取bean， 比如注册bean，参数为bean的名称，bean的定义</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> stateis0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2017/11/30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据bean的名称从容器中获取bean对象</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> name bean 名称</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> bean实例</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> Exception 异常</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">Object <span class="title">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 将bean注册到容器中</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> name bean 名称</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> bean bean实例</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> Exception 异常</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String name, BeanDefinition bean)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据Bean的名字获取Bean对象，注册参数有2个，一个是Bean的名字，一个是 BeanDefinition 对象。</p>
<p>定义完了Bean最基本的容器，还需要一个最简单 BeanDefinition  接口，我们为了方便，但因为我们这个不必考虑扩展，因此可以直接设计为类，BeanDefinition  需要哪些元素和方法呢？ 需要一个 Bean 对象，一个Class对象，一个ClassName字符串，还需要一个元素集合 PropertyValues。这些就能组成一个最基本的 BeanDefinition 类了。那么需要哪些方法呢？其实就是这些属性的get set 方法。 我们看看该类的详细：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.thinkinjava.myspring;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * bean 的定义</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> stateis0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanDefinition</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * bean</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> Object bean;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * bean 的 CLass 对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> Class beanClass;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * bean 的类全限定名称</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> String ClassName;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 类的属性集合</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> PropertyValues propertyValues = <span class="keyword">new</span> PropertyValues();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取bean对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.bean;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 设置bean的对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBean</span><span class="params">(Object bean)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.bean = bean;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取bean的Class对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Class <span class="title">getBeanclass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.beanClass;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 通过设置类名称反射生成Class对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClassname</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.ClassName = name;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.beanClass = Class.forName(name);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取bean的属性集合</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> PropertyValues <span class="title">getPropertyValues</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.propertyValues;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 设置bean的属性</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPropertyValues</span><span class="params">(PropertyValues pv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.propertyValues = pv;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有了基本的 BeanDefinition 数据结构，还需要一个从XML中读取并解析为 BeanDefinition 的操作类，首先我们定义一个 BeanDefinitionReader 接口，该接口只是一个标识，具体由抽象类去实现一个基本方法和定义一些基本属性，比如一个读取时需要存放的注册容器，还需要一个委托一个资源加载器 ResourceLoader， 用于加载XML文件，并且我们需要设置该构造器必须含有资源加载器，当然还有一些get set 方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.thinkinjava.myspring;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.thinkinjava.myspring.io.ResourceLoader;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 抽象的bean定义读取类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> stateis0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractBeanDefinitionReader</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionReader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 注册bean容器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> Map&lt;String, BeanDefinition&gt; registry;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 资源加载器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> ResourceLoader resourceLoader;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 构造器器必须有一个资源加载器， 默认插件创建一个map容器</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> resourceLoader 资源加载器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">AbstractBeanDefinitionReader</span><span class="params">(ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.registry = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取容器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Map&lt;String, BeanDefinition&gt; <span class="title">getRegistry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> registry;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取资源加载器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ResourceLoader <span class="title">getResourceLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> resourceLoader;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有了这几个抽象类和接口，我们基本能形成一个雏形，BeanDefinitionReader 用于从XML中读取配置文件，生成 BeanDefinition 实例，存放在 BeanFactory 容器中，初始化之后，就可以调用 getBean 方法获取初始化成功的Bean。形成一个完美的闭环。</p>
<h2 id="3-如何实现"><a href="#3-如何实现" class="headerlink" title="3. 如何实现"></a>3. 如何实现</h2><p>刚刚我们说了具体的流程：从XML中读取配置文件， 解析成 BeanDefinition，最终放进容器。说白了就3步。那么我们就先来设计第一步。</p>
<h3 id="1-从XML中读取配置文件，-解析成-BeanDefinition"><a href="#1-从XML中读取配置文件，-解析成-BeanDefinition" class="headerlink" title="1.  从XML中读取配置文件， 解析成 BeanDefinition"></a>1.  从XML中读取配置文件， 解析成 BeanDefinition</h3><p>我们刚刚设计了一个读取BeanDefinition 的接口 BeanDefinitionReader 和一个实现它的抽象类 AbstractBeanDefinitionReader，抽象了定义了一些简单的方法，其中由一个委托类—–ResourceLoader， 我们还没有创建， 该类是资源加载器，根据给定的路径来加载资源。我们可以使用Java 默认的类库 java.net.URL 来实现，定义两个类，一个是包装了URL的类 ResourceUrl， 一个是依赖 ResourceUrl 的资源加载类。</p>
<p><strong>ResourceUrl 代码实现</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 资源URL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceUrl</span> <span class="keyword">implements</span> <span class="title">Resource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 类库URL</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 需要一个类库URL</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ResourceUrl</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.url = url;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 从URL中获取输入流</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> InputStream <span class="title">getInputstream</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    URLConnection urlConnection = url.openConnection();</span><br><span class="line">    urlConnection.connect();</span><br><span class="line">    <span class="keyword">return</span> urlConnection.getInputStream();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ResourceLoader 实现</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 资源URL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceUrl</span> <span class="keyword">implements</span> <span class="title">Resource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 类库URL</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 需要一个类库URL</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ResourceUrl</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.url = url;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 从URL中获取输入流</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> InputStream <span class="title">getInputstream</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    URLConnection urlConnection = url.openConnection();</span><br><span class="line">    urlConnection.connect();</span><br><span class="line">    <span class="keyword">return</span> urlConnection.getInputStream();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然还需要一个接口，只定义了一个抽象方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.thinkinjava.myspring.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 资源定义</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> stateis0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Resource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取输入流</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">InputStream <span class="title">getInputstream</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好了， AbstractBeanDefinitionReader 需要的元素已经有了， 但是，很明显该方法不能实现读取 BeanDefinition 的任务。那么我们需要一个类去继承抽象类，去实现具体的方法， 既然我们是XML 配置文件读取，那么我们就定义一个 XmlBeanDefinitionReader 继承 AbstractBeanDefinitionReader ，实现一些我们需要的方法， 比如读取XML 的readrXML， 比如将解析出来的元素注册到 registry 的 Map 中， 一些解析的细节。我们还是看代码吧。 </p>
<p><strong>XmlBeanDefinitionReader  实现读取配置文件并解析成Bean</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.thinkinjava.myspring.xml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.thinkinjava.myspring.AbstractBeanDefinitionReader;</span><br><span class="line"><span class="keyword">import</span> cn.thinkinjava.myspring.BeanDefinition;</span><br><span class="line"><span class="keyword">import</span> cn.thinkinjava.myspring.BeanReference;</span><br><span class="line"><span class="keyword">import</span> cn.thinkinjava.myspring.PropertyValue;</span><br><span class="line"><span class="keyword">import</span> cn.thinkinjava.myspring.io.ResourceLoader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilder;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilderFactory;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Document;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Element;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Node;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.NodeList;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析XML文件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> stateis0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlBeanDefinitionReader</span> <span class="keyword">extends</span> <span class="title">AbstractBeanDefinitionReader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 构造器，必须包含一个资源加载器</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> resourceLoader 资源加载器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">XmlBeanDefinitionReader</span><span class="params">(ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(resourceLoader);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readerXML</span><span class="params">(String location)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 创建一个资源加载器</span></span><br><span class="line">    ResourceLoader resourceloader = <span class="keyword">new</span> ResourceLoader();</span><br><span class="line">    <span class="comment">// 从资源加载器中获取输入流</span></span><br><span class="line">    InputStream inputstream = resourceloader.getResource(location).getInputstream();</span><br><span class="line">    <span class="comment">// 获取文档建造者工厂实例</span></span><br><span class="line">    DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</span><br><span class="line">    <span class="comment">// 工厂创建文档建造者</span></span><br><span class="line">    DocumentBuilder docBuilder = factory.newDocumentBuilder();</span><br><span class="line">    <span class="comment">// 文档建造者解析流 返回文档对象</span></span><br><span class="line">    Document doc = docBuilder.parse(inputstream);</span><br><span class="line">    <span class="comment">// 根据给定的文档对象进行解析，并注册到bean容器中</span></span><br><span class="line">    registerBeanDefinitions(doc);</span><br><span class="line">    <span class="comment">// 关闭流</span></span><br><span class="line">    inputstream.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据给定的文档对象进行解析，并注册到bean容器中</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> doc 文档对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 读取文档的根元素</span></span><br><span class="line">    Element root = doc.getDocumentElement();</span><br><span class="line">    <span class="comment">// 解析元素的根节点及根节点下的所有子节点并添加进注册容器</span></span><br><span class="line">    parseBeanDefinitions(root);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 解析元素的根节点及根节点下的所有子节点并添加进注册容器</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> root XML 文件根节点</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBeanDefinitions</span><span class="params">(Element root)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 读取根元素的所有子元素</span></span><br><span class="line">    NodeList nl = root.getChildNodes();</span><br><span class="line">    <span class="comment">// 遍历子元素</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">      <span class="comment">// 获取根元素的给定位置的节点</span></span><br><span class="line">      Node node = nl.item(i);</span><br><span class="line">      <span class="comment">// 类型判断</span></span><br><span class="line">      <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</span><br><span class="line">        <span class="comment">// 强转为父类型元素</span></span><br><span class="line">        Element ele = (Element) node;</span><br><span class="line">        <span class="comment">// 解析给给定的节点，包括name，class，property， name， value，ref</span></span><br><span class="line">        processBeanDefinition(ele);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 解析给给定的节点，包括name，class，property， name， value，ref</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> ele XML 解析元素</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processBeanDefinition</span><span class="params">(Element ele)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取给定元素的 name 属性</span></span><br><span class="line">    String name = ele.getAttribute(<span class="string">"name"</span>);</span><br><span class="line">    <span class="comment">// 获取给定元素的 class 属性</span></span><br><span class="line">    String className = ele.getAttribute(<span class="string">"class"</span>);</span><br><span class="line">    <span class="comment">// 创建一个bean定义对象</span></span><br><span class="line">    BeanDefinition beanDefinition = <span class="keyword">new</span> BeanDefinition();</span><br><span class="line">    <span class="comment">// 设置bean 定义对象的 全限定类名</span></span><br><span class="line">    beanDefinition.setClassname(className);</span><br><span class="line">    <span class="comment">// 向 bean 注入配置文件中的成员变量</span></span><br><span class="line">    addPropertyValues(ele, beanDefinition);</span><br><span class="line">    <span class="comment">// 向注册容器 添加bean名称和bean定义</span></span><br><span class="line">    getRegistry().put(name, beanDefinition);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 添加配置文件中的属性元素到bean定义实例中</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> ele 元素</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> beandefinition bean定义 对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addPropertyValues</span><span class="params">(Element ele, BeanDefinition beandefinition)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取给定元素的 property 属性集合</span></span><br><span class="line">    NodeList propertyNode = ele.getElementsByTagName(<span class="string">"property"</span>);</span><br><span class="line">    <span class="comment">// 循环集合</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; propertyNode.getLength(); i++) &#123;</span><br><span class="line">      <span class="comment">// 获取集合中某个给定位置的节点</span></span><br><span class="line">      Node node = propertyNode.item(i);</span><br><span class="line">      <span class="comment">// 类型判断</span></span><br><span class="line">      <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</span><br><span class="line">        <span class="comment">// 将节点向下强转为子元素</span></span><br><span class="line">        Element propertyEle = (Element) node;</span><br><span class="line">        <span class="comment">// 元素对象获取 name 属性</span></span><br><span class="line">        String name = propertyEle.getAttribute(<span class="string">"name"</span>);</span><br><span class="line">        <span class="comment">// 元素对象获取 value 属性值</span></span><br><span class="line">        String value = propertyEle.getAttribute(<span class="string">"value"</span>);</span><br><span class="line">        <span class="comment">// 判断value不为空</span></span><br><span class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// 向给定的 “bean定义” 实例中添加该成员变量</span></span><br><span class="line">          beandefinition.getPropertyValues().addPropertyValue(<span class="keyword">new</span> PropertyValue(name, value));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 如果为空，则获取属性ref</span></span><br><span class="line">          String ref = propertyEle.getAttribute(<span class="string">"ref"</span>);</span><br><span class="line">          <span class="keyword">if</span> (ref == <span class="keyword">null</span> || ref.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果属性ref为空，则抛出异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                <span class="string">"Configuration problem: &lt;property&gt; element for property '"</span></span><br><span class="line">                    + name + <span class="string">"' must specify a ref or value"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 如果不为空，测创建一个 “bean的引用” 实例，构造参数为名称，实例暂时为空</span></span><br><span class="line">          BeanReference beanRef = <span class="keyword">new</span> BeanReference(name);</span><br><span class="line">          <span class="comment">// 向给定的 “bean定义” 中添加成员变量</span></span><br><span class="line">          beandefinition.getPropertyValues().addPropertyValue(<span class="keyword">new</span> PropertyValue(name, beanRef));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以说代码注释写的非常详细，该类方法如下：</p>
<ol>
<li>public void readerXML(String location) 公开的解析XML的方法，给定一个位置的字符串参数即可。</li>
<li>private void registerBeanDefinitions(Document doc) 给定一个文档对象，并进行解析。</li>
<li>private void parseBeanDefinitions(Element root) 给定一个根元素，循环解析根元素下所有子元素。</li>
<li>private void processBeanDefinition(Element ele) 给定一个子元素，并对元素进行解析，然后拿着解析出来的数据创建一个 BeanDefinition 对象。并注册到BeanDefinitionReader 的 Map 容器（该容器存放着解析时的所有Bean）中。</li>
<li>private void addPropertyValues(Element ele, BeanDefinition beandefinition) 给定一个元素，一个 BeanDefinition 对象，解析元素中的  property 元素， 并注入到 BeanDefinition  实例中。</li>
</ol>
<p>一共5步，完成了解析XML文件的所有操作。 最终的目的是将解析出来的文件放入到 BeanDefinitionReader 的 Map 容器中。</p>
<p>好了，到这里，我们已经完成了从XML文件读取并解析的步骤，那么什么时候放进BeanFactory的容器呢？ 刚刚我们只是放进了 AbstractBeanDefinitionReader 的注册容器中。因此我们要根据BeanFactory 的设计来实现如何构建成一个真正能用的Bean呢？因为刚才的哪些Bean只是一些Bean的信息。没有我们真正业务需要的Bean。</p>
<h3 id="2-初始化我们需要的Bean（不是Bean定义）并且实现依赖注入"><a href="#2-初始化我们需要的Bean（不是Bean定义）并且实现依赖注入" class="headerlink" title="2. 初始化我们需要的Bean（不是Bean定义）并且实现依赖注入"></a>2. 初始化我们需要的Bean（不是Bean定义）并且实现依赖注入</h3><p>我们知道Bean定义是不能干活的，只是一些Bean的信息，就好比一个人，BeanDefinition 就相当你在公安局的档案，但是你人不在公安局，可只要公安局拿着你的档案就能找到你。就是这样一个关系。</p>
<p>那我们就根据BeanFactory的设计来设计一个抽象类 AbstractBeanFactory。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.thinkinjava.myspring.factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.thinkinjava.myspring.BeanDefinition;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一个抽象类， 实现了 bean 的方法，包含一个map，用于存储bean 的名字和bean的定义</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> stateis0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractBeanFactory</span> <span class="keyword">implements</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 容器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> HashMap&lt;String, BeanDefinition&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据bean的名称获取bean， 如果没有，则抛出异常 如果有， 则从bean定义对象获取bean实例</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    BeanDefinition beandefinition = map.get(name);</span><br><span class="line">    <span class="keyword">if</span> (beandefinition == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"No bean named "</span> + name + <span class="string">" is defined"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Object bean = beandefinition.getBean();</span><br><span class="line">    <span class="keyword">if</span> (bean == <span class="keyword">null</span>) &#123;</span><br><span class="line">      bean = doCreate(beandefinition);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 注册 bean定义 的抽象方法实现，这是一个模板方法， 调用子类方法doCreate，</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String name, BeanDefinition beandefinition)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Object bean = doCreate(beandefinition);</span><br><span class="line">    beandefinition.setBean(bean);</span><br><span class="line">    map.put(name, beandefinition);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 减少一个bean</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">abstract</span> Object <span class="title">doCreate</span><span class="params">(BeanDefinition beandefinition)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该类实现了接口的2个基本方法，一个是getBean，一个是 registerBeanDefinition， 我们也设计了一个抽象方法供这两个方法调用，将具体逻辑创建逻辑延迟到子类。这是什么设计模式呢？模板模式。主要还是看 doCreate 方法，就是创建bean 具体方法，所以我们还是需要一个子类， 叫什么呢? AutowireBeanFactory， 自动注入Bean，这是我们这个标准Bean工厂的工作。看看代码吧？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.thinkinjava.myspring.factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.thinkinjava.myspring.BeanDefinition;</span><br><span class="line"><span class="keyword">import</span> cn.thinkinjava.myspring.PropertyValue;</span><br><span class="line"><span class="keyword">import</span> cn.thinkinjava.myspring.BeanReference;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现自动注入和递归注入(spring 的标准实现类 DefaultListableBeanFactory 有 1810 行)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> stateis0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutowireBeanFactory</span> <span class="keyword">extends</span> <span class="title">AbstractBeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据bean 定义创建实例， 并将实例作为key， bean定义作为value存放，并调用 addPropertyValue 方法 为给定的bean的属性进行注入</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> Object <span class="title">doCreate</span><span class="params">(BeanDefinition beandefinition)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Object bean = beandefinition.getBeanclass().newInstance();</span><br><span class="line">    addPropertyValue(bean, beandefinition);</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 给定一个bean定义和一个bean实例，为给定的bean中的属性注入实例。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addPropertyValue</span><span class="params">(Object bean, BeanDefinition beandefinition)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 循环给定 bean 的属性集合</span></span><br><span class="line">    <span class="keyword">for</span> (PropertyValue pv : beandefinition.getPropertyValues().getPropertyValues()) &#123;</span><br><span class="line">      <span class="comment">// 根据给定属性名称获取 给定的bean中的属性对象</span></span><br><span class="line">      Field declaredField = bean.getClass().getDeclaredField(pv.getname());</span><br><span class="line">      <span class="comment">// 设置属性的访问权限</span></span><br><span class="line">      declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">      <span class="comment">// 获取定义的属性中的对象</span></span><br><span class="line">      Object value = pv.getvalue();</span><br><span class="line">      <span class="comment">// 判断这个对象是否是 BeanReference 对象</span></span><br><span class="line">      <span class="keyword">if</span> (value <span class="keyword">instanceof</span> BeanReference) &#123;</span><br><span class="line">        <span class="comment">// 将属性对象转为 BeanReference 对象</span></span><br><span class="line">        BeanReference beanReference = (BeanReference) value;</span><br><span class="line">        <span class="comment">// 调用父类的 AbstractBeanFactory 的 getBean 方法，根据bean引用的名称获取实例，此处即是递归</span></span><br><span class="line">        value = getBean(beanReference.getName());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 反射注入bean的属性</span></span><br><span class="line">      declaredField.set(bean, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到 doCreate 方法使用了反射创建了一个对象，并且还需要对该对象进行属性注入，如果属性是 ref 类型，那么既是依赖关系，则需要调用 getBean 方法递归的去寻找那个Bean（因为最后一个Bean 的属性肯定是基本类型）。这样就完成了一次获取实例化Bean操作，并且也实现类依赖注入。</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>我们通过这些代码实现了一个简单的 IOC 依赖注入的功能，也更加了解了 IOC， 以后遇到Spring初始化的问题再也不会手足无措了。直接看源码就能解决。哈哈</p>
<p>具体代码楼主放在了github上，地址：<a href="https://github.com/stateIs0/simpleIoc" target="_blank" rel="noopener">自己实现的一个简单IOC,包括依赖注入</a></p>
<p>good luck ！！！</p>
</div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>