<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/img/favicon.ico"><title>蚂蚁-RPC-框架-SOFA-RPC-初体验</title></head><body>　　<div class="inner"><h2>蚂蚁-RPC-框架-SOFA-RPC-初体验</h2><p><img src="https://upload-images.jianshu.io/upload_images/4236553-d78d6c0b69a5497b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近蚂蚁金服开源了分布式框架 SOFA，楼主写了一个 demo，体验了一下 SOFA 的功能，SOFA 完全兼容 SpringBoot（当然 Dubbo 也是可以兼容的）。</p>
<p>项目地址：<a href="https://github.com/alipay/" target="_blank" rel="noopener">Alipay </a>，该主页有 5 个项目，都是阿里开源的。<br><a href="https://github.com/alipay/sofa-boot" target="_blank" rel="noopener">sofa-boot</a>，<br><a href="https://github.com/alipay/sofa-rpc" target="_blank" rel="noopener">sofa-rpc</a>，<br><a href="https://github.com/alipay/sofa-bolt" target="_blank" rel="noopener">sofa-bolt</a>，<br><a href="https://github.com/alipay/sofa-ark" target="_blank" rel="noopener">sofa-ark</a>，<br> <a href="https://github.com/alipay/sofa-rpc-boot-projects" target="_blank" rel="noopener">sofa-rpc-boot-projects</a>。</p>
<h2 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h2><p>实际上，SOFA-RPC 的官方文档已经详细介绍了如何使用这个 RPC 框架，基于 Netty 的长连接。类似 Dubbo。楼主看这个框架主要是为了学习分布式 RPC 框架的设计。</p>
<p>由于测试例子需要两个项目，我们建一个目录，目录下创建两个 maven module（SpringBoot 项目即可）：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/4236553-3fcaa5d7615b2db1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<p>一个生产者，一个消费者。</p>
<p>将这两个项目的 pom.xml 中 springBoot 的 parent 标签换成如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay.sofa<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sofaboot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>再增加一个依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay.sofa<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rpc-sofa-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>到这里，关于 RPC 框架的依赖和搭建就好了，是不是很简单？</p>
<h2 id="接口创建"><a href="#接口创建" class="headerlink" title="接口创建"></a>接口创建</h2><p>既然是 RPC 服务，那就需要一个接口，再有一个实现类。我们在提供方这里创建。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloSyncService</span> </span>&#123;</span><br><span class="line">  <span class="function">String <span class="title">saySync</span><span class="params">(String string)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloSyncServiceImpl</span> <span class="keyword">implements</span> <span class="title">HelloSyncService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">saySync</span><span class="params">(String string)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"provider tell you : this is your say: "</span> +  string;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在消费方的 pom.xml 添加对这个接口的依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.think.in.java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>有了接口，就需要配置一下。</p>
<h2 id="接口配置"><a href="#接口配置" class="headerlink" title="接口配置"></a>接口配置</h2><p>首先在提供方这里发布接口。创建一个 xml 文件，名为：rpc-sofa-boot-starter-samples.xml。</p>
<p>文件内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:sofa</span>=<span class="string">"http://sofastack.io/schema/sofaboot"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">            http://sofastack.io/schema/sofaboot   http://sofastack.io/schema/sofaboot.xsd"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">default-autowire</span>=<span class="string">"byName"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"helloSyncServiceImpl"</span> <span class="attr">class</span>=<span class="string">"cn.think.in.java.provider.HelloSyncServiceImpl"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sofa:service</span> <span class="attr">ref</span>=<span class="string">"helloSyncServiceImpl"</span> <span class="attr">interface</span>=<span class="string">"cn.think.in.java.provider.HelloSyncService"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sofa:binding.bolt</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">sofa:service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>很简单，发布了一个接口，类似 Spring 的一个 bean。</p>
<p>同时这个接口的协议是 bolt，也就是阿里的 RPC 网络通信框架 solt（基于 Netty 的最佳实践）。</p>
<p>同样的，在消费者的 resource 文件下，也创建一个同名文件。内容稍有不同。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:sofa</span>=<span class="string">"http://sofastack.io/schema/sofaboot"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">            http://sofastack.io/schema/sofaboot   http://sofastack.io/schema/sofaboot.xsd"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">default-autowire</span>=<span class="string">"byName"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">sofa:reference</span> <span class="attr">id</span>=<span class="string">"helloSyncServiceReference"</span> <span class="attr">interface</span>=<span class="string">"cn.think.in.java.provider.HelloSyncService"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sofa:binding.bolt</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">sofa:reference</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>通过接口得到一个 bean。</p>
<p>好，接口的配置好了，那么就可以启动测试了。</p>
<h2 id="准备测试"><a href="#准备测试" class="headerlink" title="准备测试"></a>准备测试</h2><p>测试之前还要做点点工作。</p>
<p>在提供者配置文件 appcation.perproties 中，配置一下端口和程序名称。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># server.port=8080 # 默认</span><br><span class="line">spring.application.name=provider</span><br></pre></td></tr></table></figure>
<p>默认 8080 端口，就不必配置了。</p>
<p>然后，在消费者那里同样配置这个文件。内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=consumer</span><br><span class="line">server.port=<span class="number">8081</span></span><br></pre></td></tr></table></figure>
<p>消费者和提供者端口不能冲突。</p>
<p>还剩最后一步。</p>
<p>将文件引入到 Spring 容器中。</p>
<p>在提供者启动类上加入以下内容（引入配置文件）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ImportResource</span>(&#123; <span class="string">"classpath*:rpc-sofa-boot-starter-samples.xml"</span> &#125;)</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(ProviderApplication.class, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在消费者启动类中引入以下内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ImportResource</span>(&#123; <span class="string">"classpath*:rpc-sofa-boot-starter-samples.xml"</span> &#125;)</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication springApplication = <span class="keyword">new</span> SpringApplication(ConsumerApplication.class);</span><br><span class="line">    ApplicationContext applicationContext = springApplication.run(args);</span><br><span class="line"></span><br><span class="line">    HelloSyncService helloSyncServiceReference = (HelloSyncService) applicationContext</span><br><span class="line">        .getBean(<span class="string">"helloSyncServiceReference"</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(helloSyncServiceReference.saySync(<span class="string">"sync"</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>稍微多点东西，但也还是挺简单的。</p>
<p>首先创建一个 Spring 启动类。然后运行，从 Spirng 容器中获取到 bean（被动态代理封装的远程调用）。然后调用代理方法。</p>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>先运行提供者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span>-<span class="number">04</span>-<span class="number">23</span> <span class="number">23</span>:<span class="number">18</span>:<span class="number">24.776</span>  INFO <span class="number">26654</span> --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped <span class="string">"&#123;[/env/&#123;name:.*&#125;],methods=[GET],produces=[application/json]&#125;"</span> onto <span class="keyword">public</span> java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EnvironmentMvcEndpoint.value(java.lang.String)</span><br><span class="line"><span class="number">2018</span>-<span class="number">04</span>-<span class="number">23</span> <span class="number">23</span>:<span class="number">18</span>:<span class="number">24.776</span>  INFO <span class="number">26654</span> --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped <span class="string">"&#123;[/env || /env.json],methods=[GET],produces=[application/json]&#125;"</span> onto <span class="keyword">public</span> java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()</span><br><span class="line"><span class="number">2018</span>-<span class="number">04</span>-<span class="number">23</span> <span class="number">23</span>:<span class="number">18</span>:<span class="number">24.886</span>  INFO <span class="number">26654</span> --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Registering beans <span class="keyword">for</span> JMX exposure on startup</span><br><span class="line"><span class="number">2018</span>-<span class="number">04</span>-<span class="number">23</span> <span class="number">23</span>:<span class="number">18</span>:<span class="number">24.893</span>  INFO <span class="number">26654</span> --- [           main] o.s.c.support.DefaultLifecycleProcessor  : Starting beans in phase <span class="number">0</span></span><br><span class="line">Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.remoting Logback ]</span><br><span class="line"><span class="number">2018</span>-<span class="number">04</span>-<span class="number">23</span> <span class="number">23</span>:<span class="number">18</span>:<span class="number">24.966</span>  INFO <span class="number">26654</span> --- [           main] com.alipay.sofa.common.log               : Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.remoting Logback ]</span><br><span class="line"><span class="number">2018</span>-<span class="number">04</span>-<span class="number">23</span> <span class="number">23</span>:<span class="number">18</span>:<span class="number">25.174</span>  INFO <span class="number">26654</span> --- [           main] s.b.c.e.t.TomcatEmbeddedServletContainer : <span class="function">Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2018-04-23 23:18:25.179  INFO 26654 --- [           main] c.t.i.java.provider.ProviderApplication  : Started ProviderApplication in 3.352 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">3.978</span>)</span></span></span><br><span class="line"><span class="function">```  </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">再运行消费者：</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">```java</span></span><br><span class="line"><span class="function">2018-04-23 23:19:21.940  INFO 26673 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "</span>&#123;[/env || /env.json],methods=[GET],produces=[application/json]&#125;<span class="string">" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()</span></span><br><span class="line"><span class="string">2018-04-23 23:19:22.055  INFO 26673 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Registering beans for JMX exposure on startup</span></span><br><span class="line"><span class="string">2018-04-23 23:19:22.063  INFO 26673 --- [           main] o.s.c.support.DefaultLifecycleProcessor  : Starting beans in phase 0</span></span><br><span class="line"><span class="string">2018-04-23 23:19:22.319  INFO 26673 --- [           main] s.b.c.e.t.TomcatEmbeddedServletContainer : Tomcat started on port(s): 8081 (http)</span></span><br><span class="line"><span class="string">2018-04-23 23:19:22.324  INFO 26673 --- [           main] c.t.i.java.consumer.ConsumerApplication  : Started ConsumerApplication in 3.898 seconds (JVM running for 4.524)</span></span><br><span class="line"><span class="string">provider tell you : this is your say: sync</span></span><br></pre></td></tr></table></figure>
<p>成功打印结果。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>首先第一感觉是，这个框架还是挺好用，挺简单的，基于当前的 SpringBoot 。快速启动。而且不是 SpringCloud 的 Http 调用，使用 Netty 作为网络通信框架，性能当然是没有问题的。</p>
<p>当然，我们这里的 demo 使用的注册中心没有使用 ZK，毕竟初体验嘛，使用的本地的文件。</p>
<p>然而，楼主对这个框架有很大的兴趣。接下来的空闲时间里，楼主将好好研究 SOFA 相关的代码。</p>
</div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>